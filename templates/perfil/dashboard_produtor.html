{% extends "base.html" %}

{% block title %}Painel do Produtor ‚Äî AgroKongo{% endblock %}

{% block content %}
<div class="dashboard-wrapper" style="background: radial-gradient(circle at top right, #f8fafc 0%, #f1f5f9 100%); min-height: 100vh;">

    <div class="container py-4 py-lg-5 animate__animated animate__fadeIn font-sharp">

        <div class="row mb-5 align-items-center">
            <div class="col-lg-8">
                <div class="d-flex align-items-center gap-4">
                    <div class="profile-avatar shadow-lg rounded-circle border border-white border-4 d-none d-md-flex align-items-center justify-content-center bg-success text-white fw-900 fs-3" style="width: 80px; height: 80px;">
                        {{ current_user.nome[0]|upper if current_user.nome else 'P' }}
                    </div>
                    <div>
                        <span class="badge bg-success-dark text-white rounded-pill px-3 py-1 fw-800 tiny ls-2 mb-2">PRODUTOR VERIFICADO</span>
                        <h1 class="fw-900 text-dark-sharp mb-0 display-6" style="letter-spacing: -2px;">Ol√°, {{ current_user.nome.split(' ')[0] if current_user.nome else 'Produtor' }}! üá¶üá¥</h1>
                        <p class="text-slate-bold fw-600 m-0 fs-5 mt-1">
                            <i class="bi bi-calendar3 text-success me-2"></i>{{ current_date or 'S√°bado, 27 de Dezembro' }}
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 text-lg-end mt-4 mt-lg-0">
                <a href="{{ url_for('perfil.nova_safra') }}" class="btn btn-success-dark px-4 py-3 rounded-4 shadow-green fw-900 transition-all hover-up border-0">
                    <i class="bi bi-plus-lg me-2"></i>Publicar Safra
                </a>
            </div>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="card-glass p-4 rounded-5 border-0 shadow-sm h-100">
                    <span class="label-caps text-slate-bold mb-1 d-block">Volume de Vendas</span>
                    {# Prote√ß√£o (valor or 0) para evitar erro de formata√ß√£o #}
                    <h2 class="fw-900 m-0 text-dark-sharp">{{ (total_ganho or 0)|formata_kz }}</h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card-glass p-4 rounded-5 border-0 shadow-sm h-100">
                    <span class="label-caps text-slate-bold mb-1 d-block">Lotes Ativos</span>
                    <h2 class="fw-900 m-0 text-dark-sharp">{{ total_ativas or 0 }} <small class="fs-6 text-slate-bold fw-700">an√∫ncios</small></h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card-dark p-4 rounded-5 border-0 shadow-lg h-100 position-relative">
                    <span class="label-caps text-white-50 mb-1 d-block">Interesses no Radar</span>
                    <h2 class="fw-900 m-0 text-white display-6">{{ pedidos_radar|length if pedidos_radar else 0 }}</h2>
                    <div class="mt-3">
                        <span class="badge bg-warning text-dark rounded-pill fw-900 tiny px-3">AGUARDANDO RESPOSTA</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-8">

                <div class="section-card bg-white rounded-5 shadow-sm p-4 p-md-5 border border-light-sharp mb-4">
                    <h4 class="fw-900 text-dark-sharp mb-4">Monitor de Vendas</h4>
                    {% for op in oportunidades %}
                    <div class="order-item p-4 mb-4 rounded-5 border-2 border-light-sharp">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="bg-light p-3 rounded-4 fs-3">üì¶</div>
                                    <div>
                                        <h6 class="fw-900 text-dark-sharp m-0">{{ op.comprador.nome }}</h6>
                                        <p class="text-slate-bold tiny fw-800 m-0">REF: {{ op.fatura_ref }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <span class="label-caps text-slate-bold d-block mb-1">Total</span>
                                <span class="fw-900 text-success-dark fs-5">{{ (op.preco_total or 0)|formata_kz }}</span>
                            </div>
                            <div class="col-md-3 text-md-end">
                                {% if op.status == 'pago_custodia' %}
                                    <form action="{{ url_for('perfil.confirmar_entrega_final', id=op.id) }}" method="POST">
                                        <button class="btn btn-success-dark rounded-pill w-100 fw-900 py-2 border-0 shadow-green">Confirmar Entrega</button>
                                    </form>
                                {% else %}
                                    <span class="badge-custom-sharp bg-warning text-dark w-100 text-center d-block">AGUARDANDO PAGAMENTO</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <p class="text-muted">Nenhuma venda ativa no momento.</p>
                    </div>
                    {% endfor %}
                </div>

                <div class="section-card bg-white rounded-5 shadow-sm p-4 p-md-5 border border-light-sharp">
                    <h4 class="fw-900 text-dark-sharp mb-4">Radar de Procura üì°</h4>

                    {% for pedido in pedidos_radar %}
                    <div class="p-4 mb-3 rounded-5 border-2 border-light-sharp bg-light-sharp hover-up transition-all">
                        <div class="row align-items-center">
                            <div class="col-md-1 text-center d-none d-md-block fs-3">
                                {# Caminho correto: Interesse -> Safra -> Produto #}
                                {% if pedido.safra and pedido.safra.produto and 'Tomate' in pedido.safra.produto.nome %}üçÖ{% elif pedido.safra and pedido.safra.produto and 'Milho' in pedido.safra.produto.nome %}üåΩ{% else %}üì¶{% endif %}
                            </div>
                            <div class="col-md-7">
                                <h6 class="fw-900 text-dark-sharp mb-1 fs-5">{{ pedido.safra.produto.nome if (pedido.safra and pedido.safra.produto) else 'Produto Indefinido' }}</h6>
                                <div class="d-flex gap-3">
                                    <span class="text-success-dark fw-800 small">
                                        <i class="bi bi-box-fill"></i> {{ pedido.quantidade_pretendida }}kg
                                    </span>
                                    <span class="text-slate-bold fw-700 small">
                                        <i class="bi bi-person-fill"></i> {{ pedido.comprador.nome if pedido.comprador else 'Usu√°rio' }}
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-4 text-md-end mt-3 mt-md-0">
                                <form action="{{ url_for('perfil.aceitar_pedido', id=pedido.id) }}" method="POST">
                                    <button type="submit" class="btn btn-dark-sharp rounded-pill px-4 fw-900 w-100 py-2 border-0">
                                        Aceitar Pedido
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-radar display-4 text-muted opacity-25"></i>
                        <p class="fw-800 text-slate-bold mt-3">Nenhum interesse pendente.</p>
                    </div>
                    {% endfor %}
                </div>

            </div>

            <div class="col-lg-4">
                <div class="section-card bg-white rounded-5 shadow-sm p-4 border border-light-sharp">
                    <h4 class="fw-900 text-dark-sharp mb-4">Invent√°rio</h4>
                    {% for safra in safras %}
                    <div class="inventory-card p-3 rounded-4 border-2 border-light-sharp mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="fw-900 text-dark-sharp d-block fs-6 mb-1">{{ safra.produto.nome }}</span>
                                <span class="badge bg-light-sharp text-success-dark fw-900 tiny">{{ safra.quantidade_kg }}kg</span>
                            </div>
                            <div class="text-end">
                                <p class="fw-900 text-dark-sharp m-0 small">{{ (safra.preco_kg or 0)|formata_kz }}</p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .font-sharp { -webkit-font-smoothing: antialiased; }
    .text-dark-sharp { color: #0f172a !important; }
    .text-slate-bold { color: #64748b !important; }
    .text-success-dark { color: #15803d !important; }
    .card-glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 1px solid #e2e8f0 !important; }
    .card-dark { background: #1e293b; color: white; }
    .bg-light-sharp { background-color: #f8fafc !important; }
    .btn-success-dark { background-color: #15803d !important; color: white; }
    .btn-dark-sharp { background-color: #0f172a; color: white; }
    .label-caps { font-size: 0.68rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px; }
    .badge-custom-sharp { padding: 6px 12px; border-radius: 50px; font-size: 0.65rem; font-weight: 900; text-transform: uppercase; }
    .hover-up:hover { transform: translateY(-3px); transition: 0.2s; }
</style>
{% endblock %}